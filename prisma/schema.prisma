// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  admin
  user
}

enum Status {
  open
  closed
}

enum Type {
  subscription
  transfer
  maturity
}

enum BondType {
  government_Bond
  corporate_Bond
  green_Bond
  development_Bond
  domestic_Bond
}

enum Market {
  current
  resale
}

enum KYCStatus {
  pending
  verified
  rejected
  error
}

enum ListingStatus {
  open
  filled
  cancelled
}

enum NegotiationStatus {
  pending
  accepted
  rejected
  cancelled
}

model NegotiationOffers {
  id String @id @default(cuid())

  // Relations to core entities
  bond_id        String
  listing_id     String
  buyer_user_id  String
  seller_user_id String

  // Wallets (denormalised for convenience)
  buyer_wallet  String
  seller_wallet String

  // How many bond units / tenths are being requested
  units        Int // e.g. 5 units
  units_tenths BigInt // e.g. 50 if each unit = 10 tenths

  // Negotiated economics
  original_interest_rate Float // from listing / bond, e.g. 7.5
  proposed_interest_rate Float // buyerâ€™s proposed rate (if you want to allow it)
  proposed_total_amount  BigInt // BTNC smallest units for full purchase

  status NegotiationStatus @default(pending)

  // Optional metadata
  note       String? // free-text message with the offer
  tx_hash    String? // filled later if you execute on-chain
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  bond    Bonds    @relation(fields: [bond_id], references: [id], onDelete: Cascade)
  listing Listings @relation(fields: [listing_id], references: [id], onDelete: Cascade)

  buyer  Users @relation("BuyerNegotiationOffers", fields: [buyer_user_id], references: [id], onDelete: Cascade)
  seller Users @relation("SellerNegotiationOffers", fields: [seller_user_id], references: [id], onDelete: Cascade)
}

model Users {
  id              String    @id @default(cuid())
  name            String?
  national_id     BigInt    @unique
  wallet_address  String?   @unique
  salt            String
  email           String    @unique
  date_of_birth   DateTime?
  password        String?
  role            Role
  hashed_mnemonic String?
  created_at      DateTime  @default(now())
  kyc_status      KYCStatus @default(pending)

  // Relations
  ekyc             EKYCVerifications[]
  subscriptions    Subscriptions[]
  events           Events[]
  transactionsFrom Transactions[]      @relation("TransactionsFrom")
  transactionsTo   Transactions[]      @relation("TransactionsTo")
  allocations      Allocations[]
  listings         Listings[]          @relation("UserListings")

  // NEW: negotiation offers
  negotiationBuyerOffers  NegotiationOffers[] @relation("BuyerNegotiationOffers")
  negotiationSellerOffers NegotiationOffers[] @relation("SellerNegotiationOffers")
}

model EKYCVerifications {
  id                String    @id @default(cuid())
  user_id           String
  national_id_hash  String // SHA256 hash, not the raw national ID
  date_of_birth     DateTime
  age               Int?
  custodial_address String
  tx_digest         String?
  status            KYCStatus @default(pending)
  reason            String?
  request_id        String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  // Relations
  user Users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Bonds {
  id                    String   @id @default(cuid())
  bond_object_id        String?
  bond_name             String
  bond_type             BondType
  bond_symbol           String
  organization_name     String
  face_value            BigInt
  tl_unit_offered       Int
  tl_unit_subscribed    Int?
  maturity              DateTime
  status                Status
  interest_rate         String
  purpose               String
  market                Market?
  created_at            DateTime @default(now())
  subscription_period   Int
  subscription_end_date DateTime
  allocated             Boolean?

  // Relations
  subscriptions     Subscriptions[]
  events            Events[]
  allocations       Allocations[]
  listings          Listings[]          @relation("BondListings")
  negotiationOffers NegotiationOffers[]
}

model Events {
  id         String   @id @default(cuid())
  type       Type
  bond_id    String
  user_id    String
  details    String
  tx_hash    String
  created_at DateTime @default(now())

  // Relations
  bond Bonds @relation(fields: [bond_id], references: [id], onDelete: Cascade)
  user Users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Subscriptions {
  id               String   @id @default(cuid())
  bond_id          String
  user_id          String
  wallet_address   String
  committed_amount BigInt
  tx_hash          String
  subscription_amt BigInt?
  created_at       DateTime @default(now())

  // Relations
  bond Bonds @relation(fields: [bond_id], references: [id], onDelete: Cascade)
  user Users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Transactions {
  id         String   @id @default(cuid())
  user_from  String
  user_to    String
  tx_hash    String
  created_at DateTime @default(now())

  // Relations
  from Users @relation("TransactionsFrom", fields: [user_from], references: [id], onDelete: Cascade)
  to   Users @relation("TransactionsTo", fields: [user_to], references: [id], onDelete: Cascade)
}

model Allocations {
  id               String   @id @default(cuid())
  bond_id          String
  user_id          String
  wallet_address   String
  allocated_tenths BigInt // in tenths, same as on-chain
  tx_hash          String
  created_at       DateTime @default(now())

  bond Bonds @relation(fields: [bond_id], references: [id], onDelete: Cascade)
  user Users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Listings {
  id              String        @id @default(cuid())
  bond_id         String // required
  seller_user_id  String // required
  seller_wallet   String
  listing_onchain Int // u64 listing_id from Move
  amount_tenths   BigInt // quantity listed
  status          ListingStatus @default(open)
  tx_hash         String
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  // Relations
  bond              Bonds               @relation("BondListings", fields: [bond_id], references: [id], onDelete: Cascade)
  seller            Users               @relation("UserListings", fields: [seller_user_id], references: [id], onDelete: Cascade)
  negotiationOffers NegotiationOffers[]
}
